<!DOCTYPE html>
<html>
  <head>
    <title>ìŒì„±í•™ ì‹¤í—˜ Phonetics Experiment</title>
    <script src="jspsych/jspsych.js"></script>
    <link href="jspsych/jspsych.css" rel="stylesheet" type="text/css" />
    <script src="jspsych/plugin-html-keyboard-response.js"></script>
    <script src="jspsych/plugin-html-button-response.js"></script>
    <style>
      .jspsych-btn {
        font-size: 24px;
        padding: 20px 40px;
        margin: 10px;
        width: 150px;
        height: 60px;
      }
      .jspsych-content {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: 80vh;
      }
      input[type="number"], input[type="text"] {
        font-size: 20px;
        padding: 5px;
        width: 200px;
        margin: 10px;
      }
      .button-row {
        display: flex;
        justify-content: center;
        margin-bottom: 10px;
      }
      .emoji {
        font-size: 48px;
        margin: 10px 0;
      }
    </style>
  </head>
  <body></body>
  <script>
    var jsPsych = initJsPsych({});
    var timeline = [];
    var responses = {};
    var context = new (window.AudioContext || window.webkitAudioContext)();

    function playAudioWithFade(audioFile, context, fadePercentage) {
      const source = context.createBufferSource();
      const gainNode = context.createGain();
      source.connect(gainNode).connect(context.destination);

      fetch(audioFile)
        .then((response) => response.arrayBuffer())
        .then((arrayBuffer) => context.decodeAudioData(arrayBuffer))
        .then((audioBuffer) => {
          source.buffer = audioBuffer;

          const fadeDuration = audioBuffer.duration * fadePercentage;
          const audioDuration = audioBuffer.duration;

          gainNode.gain.setValueAtTime(0, context.currentTime);
          gainNode.gain.linearRampToValueAtTime(1, context.currentTime + fadeDuration);
          gainNode.gain.setValueAtTime(1, context.currentTime + audioDuration - fadeDuration);
          gainNode.gain.linearRampToValueAtTime(0, context.currentTime + audioDuration);

          source.start();
        });
    }

    // ì‹œì‘ í™”ë©´
    var welcome_page = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `
        <p style="font-size: 20px;">ì•ˆë…•í•˜ì„¸ìš”, ì‹¤í—˜ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤.</p>
        <p style="font-size: 20px; font-weight: bold;">ì‹¤í—˜ ì˜ˆìƒ ì†Œìš”ì‹œê°„ì€ ì•½ 10~15ë¶„ì…ë‹ˆë‹¤.</p>
        <p style="font-size: 20px;">ìŠ¤í˜ì´ìŠ¤ë°”ë¥¼ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”.</p>
      `,
      choices: [' ']
    };
    timeline.push(welcome_page);

    // ì„±ë³„ ì…ë ¥
    var sex_page = {
      type: jsPsychHtmlButtonResponse,
      stimulus: `
        <p style="font-size: 20px;">ê·€í•˜ì˜ ì„±ë³„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
      `,
      choices: ['ë‚¨ì„±', 'ì—¬ì„±'],
      on_finish: function(data) {
        jsPsych.data.addProperties({ sex: data.response === 0 ? 'ë‚¨ì„±' : 'ì—¬ì„±' });
      }
    };
    timeline.push(sex_page);

    // ë‚˜ì´ ì…ë ¥
    var age_page = {
      type: jsPsychHtmlButtonResponse,
      stimulus: `
        <p style="font-size: 20px;">ê·€í•˜ì˜ ì—°ë ¹(ë§Œ ë‚˜ì´ ê¸°ì¤€)ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
        <input type="number" id="age-input" placeholder="ë‚˜ì´ë¥¼ ì…ë ¥í•˜ì„¸ìš”" />
      `,
      choices: ['í™•ì¸'],
      on_finish: function() {
        const ageInput = document.getElementById('age-input')?.value || 'ë¯¸ì…ë ¥';
        jsPsych.data.addProperties({ age: ageInput });
      }
    };
    timeline.push(age_page);

    // í”„ë‘ìŠ¤ì–´ í•™ìŠµ ì—¬ë¶€
    var french_page = {
      type: jsPsychHtmlButtonResponse,
      stimulus: `
        <p style="font-size: 20px;">ê·€í•˜ëŠ” í”„ë‘ìŠ¤ì–´ë¥¼ ì œ2ì™¸êµ­ì–´ë¡œ í•™ìŠµí•œ ê²½í—˜ì´ ìˆìŠµë‹ˆê¹Œ?</p>
      `,
      choices: ['ì˜ˆ', 'ì•„ë‹ˆì˜¤'],
      on_finish: function(data) {
        jsPsych.data.addProperties({ french_experience: data.response === 0 ? 'ì˜ˆ' : 'ì•„ë‹ˆì˜¤' });
      }
    };
    timeline.push(french_page);

    // í—¤ë“œí° ì°©ìš© ì•ˆë‚´
    var headphone_check = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `
        <p style="font-size: 20px;">ì´ ì‹¤í—˜ì€ ìŒì„± ì¸ì§€ ì‹¤í—˜ìœ¼ë¡œ,</p>
        <p style="font-size: 20px; color: red; font-weight: bold;">âš ï¸ ì´ì–´í° ë˜ëŠ” í—¤ë“œí°ì„ ë°˜ë“œì‹œ ì°©ìš©í•´ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤. âš ï¸</p>
        <p style="font-size: 20px;">ì¡°ìš©í•œ í™˜ê²½ì—ì„œ ì‹¤í—˜ì„ ì§„í–‰í•´ ì£¼ì„¸ìš”.</p>
        <p style="font-size: 20px;">ìŠ¤í˜ì´ìŠ¤ë°”ë¥¼ ëˆŒëŸ¬ ì§„í–‰í•˜ì„¸ìš”.</p>
      `,
      choices: [' ']
    };
    timeline.push(headphone_check);

    // Trial Test
    var trial_file = { stimulus: 'SoundStimuli/trial.wav' };

    var trial_block = {
      type: jsPsychHtmlButtonResponse,
      stimulus: function () {
        var stim = trial_file.stimulus;
        playAudioWithFade(stim, context, 0.13);
        return `
          <p style="font-size: 20px;">TRIAL TEST ì—°ìŠµ</p>
          <div class="emoji">ğŸ”Š</div>
          <p style="font-size: 20px; font-weight: bold;">ğŸ§ ë³¼ë¥¨ í™˜ê²½ì„ ì²´í¬í•´ ì£¼ì„¸ìš”.</p>
          <p style="font-size: 20px;">ë“¤ë¦¬ëŠ” ì†Œë¦¬ì™€ ê°€ì¥ ìœ ì‚¬í•˜ë‹¤ê³  ìƒê°í•˜ëŠ” í•œêµ­ì–´ ëª¨ìŒì„ ê³¨ë¼ì£¼ì„¸ìš”.</p>
          <div class="button-row">
            <button class="jspsych-btn">ã…œ</button>
            <button class="jspsych-btn">ã…¡</button>
            <button class="jspsych-btn">ã…£</button>
          </div>
          <div class="button-row">
            <button class="jspsych-btn">ã…Ÿ</button>
            <button class="jspsych-btn">ã…š</button>
            <button class="jspsych-btn">ã…/ã…”</button>
            <button class="jspsych-btn">ã…“</button>
          </div>
        `;
      },
      choices: [],
      on_load: function() {
        const buttons = document.querySelectorAll('.jspsych-btn');
        buttons.forEach((button) => {
          button.addEventListener('click', function() {
            const response = button.textContent;
            jsPsych.finishTrial({ response });
          });
        });
      },
      on_finish: function (data) {
        responses['Trial Stimulus'] = {
          response: data.response
        };
      }
    };
    timeline.push(trial_block);

    // ë³¸ ì‹¤í—˜ ì•ˆë‚´
    var instructions_page = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `
        <p style="font-size: 20px;">ì´ì œ ë³¸ ì‹¤í—˜ì„ ì‹œì‘í•˜ê² ìŠµë‹ˆë‹¤.</p>
        <p style="font-size: 20px;">ìŠ¤í˜ì´ìŠ¤ë°”ë¥¼ ëˆŒëŸ¬ ì§„í–‰í•˜ì„¸ìš”.</p>
      `,
      choices: [' ']
    };
    timeline.push(instructions_page);

    // Stimuli ì¤€ë¹„
    var stimuli_files = [
      "SoundStimuli/A1.wav", "SoundStimuli/A3.wav", "SoundStimuli/A5.wav", "SoundStimuli/A7.wav", "SoundStimuli/A9.wav", 
      "SoundStimuli/A11.wav", "SoundStimuli/A13.wav", "SoundStimuli/A15.wav", 
      "SoundStimuli/B2.wav", "SoundStimuli/B4.wav", "SoundStimuli/B6.wav", "SoundStimuli/B8.wav", "SoundStimuli/B10.wav", 
      "SoundStimuli/B12.wav", "SoundStimuli/B14.wav", "SoundStimuli/B16.wav", 
      "SoundStimuli/C3.wav", "SoundStimuli/C5.wav", "SoundStimuli/C7.wav", "SoundStimuli/C9.wav", "SoundStimuli/C11.wav", 
      "SoundStimuli/C13.wav", "SoundStimuli/C15.wav", 
      "SoundStimuli/D4.wav", "SoundStimuli/D6.wav", "SoundStimuli/D8.wav", "SoundStimuli/D10.wav", "SoundStimuli/D12.wav", 
      "SoundStimuli/D14.wav", "SoundStimuli/D16.wav", 
      "SoundStimuli/E5.wav", "SoundStimuli/E7.wav", "SoundStimuli/E9.wav", "SoundStimuli/E11.wav", "SoundStimuli/E13.wav", 
      "SoundStimuli/E15.wav", 
      "SoundStimuli/F6.wav", "SoundStimuli/F8.wav", "SoundStimuli/F10.wav", "SoundStimuli/F12.wav", "SoundStimuli/F14.wav", 
      "SoundStimuli/F16.wav", 
      "SoundStimuli/G7.wav", "SoundStimuli/G9.wav", "SoundStimuli/G11.wav", "SoundStimuli/G13.wav", "SoundStimuli/G15.wav", 
      "SoundStimuli/H8.wav", "SoundStimuli/H10.wav", "SoundStimuli/H12.wav", "SoundStimuli/H14.wav", "SoundStimuli/H16.wav", 
      "SoundStimuli/I9.wav", "SoundStimuli/I11.wav", "SoundStimuli/I13.wav", "SoundStimuli/I15.wav", 
      "SoundStimuli/J10.wav", "SoundStimuli/J12.wav", "SoundStimuli/J14.wav", "SoundStimuli/J16.wav", 
      "SoundStimuli/K11.wav", "SoundStimuli/K13.wav", "SoundStimuli/K15.wav", 
      "SoundStimuli/L12.wav", "SoundStimuli/L14.wav", "SoundStimuli/L16.wav", 
      "SoundStimuli/M13.wav", "SoundStimuli/M15.wav", 
      "SoundStimuli/N14.wav", "SoundStimuli/N16.wav", 
      "SoundStimuli/O15.wav", "SoundStimuli/P16.wav"
    ];

    var counter = 1;

    var response_block = {
      type: jsPsychHtmlButtonResponse,
      stimulus: function () {
        var stim = jsPsych.timelineVariable("stimulus");
        playAudioWithFade(stim, context, 0.13);
        return `
          <p style="font-size: 20px;">Stimuli ${counter}</p>
          <div class="emoji">ğŸ”Š</div>
          <p style="font-size: 20px;">ë“¤ë¦¬ëŠ” ì†Œë¦¬ì™€ ê°€ì¥ ìœ ì‚¬í•˜ë‹¤ê³  ìƒê°í•˜ëŠ” í•œêµ­ì–´ ëª¨ìŒì„ ê³¨ë¼ì£¼ì„¸ìš”.</p>
          <div class="button-row">
            <button class="jspsych-btn">ã…œ</button>
            <button class="jspsych-btn">ã…¡</button>
            <button class="jspsych-btn">ã…£</button>
          </div>
          <div class="button-row">
          <button class="jspsych-btn">ã…Ÿ</button>
            <button class="jspsych-btn">ã…š</button>
            <button class="jspsych-btn">ã…/ã…”</button>
            <button class="jspsych-btn">ã…“</button>
          </div>
        `;
      },
      choices: [],
      on_load: function() {
        const buttons = document.querySelectorAll('.jspsych-btn');
        buttons.forEach((button) => {
          button.addEventListener('click', function() {
            const response = button.textContent;
            jsPsych.finishTrial({ response });
          });
        });
      },
      on_finish: function (data) {
        responses[`Stimulus ${counter}`] = {
          response: data.response,
          response_time: data.rt,
          stimulus_file: jsPsych.timelineVariable("stimulus", true)
        };
        counter++;
      }
    };

    var procedure = {
      timeline: [response_block],
      timeline_variables: stimuli_files.map(file => ({ stimulus: file })),
      randomize_order: true
    };
    timeline.push(procedure);

    // ì¢…ë£Œ í˜ì´ì§€
    var debrief_block = {
      type: jsPsychHtmlButtonResponse,
      stimulus: `
        <p style="font-size: 20px; font-weight: bold;">ì‹¤í—˜ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì°¸ì—¬í•´ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤.</p>
        <p style="font-size: 20px;">í•˜ë‹¨ì— ì „í™”ë²ˆí˜¸ë¥¼ ì‘ì„±í•˜ì‹œë©´ ì¶”ì²¨ì„ í†µí•´ ì„ ë¬¼ì„ ë“œë¦½ë‹ˆë‹¤.</p>
        <p style="font-size: 20px;">(ê°œì¸ì •ë³´ëŠ” ì‹¤í—˜ ì¢…ë£Œ í›„ íê¸°í•©ë‹ˆë‹¤.)</p>
        <input type="text" id="phone-input" placeholder="ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" />
      `,
      choices: ['ì œì¶œ'],
      on_finish: function() {
        const phoneInput = document.getElementById('phone-input')?.value || 'ë¯¸ì…ë ¥';
        jsPsych.data.addProperties({ phone: phoneInput });

        var participant_data = {
          Timestamp: new Date().toISOString(),
          Sex: jsPsych.data.get().values()[0].sex,
          Age: jsPsych.data.get().values()[0].age,
          Phone: phoneInput,
          'Trial Stimulus': responses['Trial Stimulus']?.response || '',
          ...Object.entries(responses).reduce((acc, [key, value]) => {
            if (key.startsWith('Stimulus')) {
              acc[key] = value.stimulus_file;
              acc[`Response ${key}`] = value.response;
              acc[`RT ${key}`] = value.response_time;
            }
            return acc;
          }, {})
        };

        fetch("https://script.google.com/macros/s/AKfycbyq-cPOiqvDtTaJNLlz-qE7icmLwZL-YIo5ySgztAiCkC9Ln9OMCOEDH7FOadmwmNvn/exec", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(participant_data),
        })
          .then((response) => response.text())
          .then((result) => console.log("Data sent:", result))
          .catch((error) => console.error("Error:", error));
      }
    };
    timeline.push(debrief_block);

    jsPsych.run(timeline);
  </script>
</html>
